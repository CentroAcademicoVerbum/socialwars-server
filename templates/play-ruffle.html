<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ============================================================
         Social Wars — Ruffle Player (Modern Responsive Edition)
         Compatível com Flask (Jinja2), Firebase Auth, Ruffle self-hosted
         ============================================================ -->
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="mobile-web-app-capable" content="yes"/>

    <title>Social Wars — Ruffle</title>
    <link rel="shortcut icon" href="img/icon.png"/>
    <link rel="icon" type="image/png" href="img/icon.png"/>

    <style>
        /* ==========================================================
           CSS RESET & BASE
           ========================================================== */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
            touch-action: manipulation;
        }

        body {
            font-family: 'Segoe UI', 'Inter', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0d0d0d 0%, #1a1a2e 40%, #16213e 70%, #0f3460 100%);
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            position: relative;
        }

        /* Fundo com partículas sutis via pseudo-elemento */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background:
                radial-gradient(ellipse at 20% 50%, rgba(72, 49, 157, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(0, 180, 216, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 80%, rgba(114, 9, 183, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* ==========================================================
           HEADER — Informações de sessão
           ========================================================== */
        #header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            background: rgba(10, 10, 20, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            transition: transform 0.3s ease;
        }

        #header.hidden {
            transform: translateY(-100%);
        }

        #header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #header-logo {
            width: 28px;
            height: 28px;
            border-radius: 6px;
        }

        #header-title {
            font-size: 14px;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: 0.5px;
        }

        #header-title span {
            background: linear-gradient(90deg, #00b4d8, #7209b7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        #session-info {
            font-size: 12px;
            color: #a0a0b0;
        }

        #session-info b {
            color: #e0e0f0;
            font-weight: 600;
        }

        #session-info a {
            color: #00b4d8;
            text-decoration: none;
            margin-left: 8px;
            font-weight: 500;
            transition: color 0.2s;
        }

        #session-info a:hover {
            color: #48cae4;
        }

        /* ==========================================================
           GAME CONTAINER — Área principal do jogo
           ========================================================== */
        #game-wrapper {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100vh;
            padding: 48px 0 0 0;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 960px;
            aspect-ratio: 760 / 600;
            max-height: calc(100vh - 56px);
            border-radius: 12px;
            overflow: hidden;
            box-shadow:
                0 0 0 1px rgba(255, 255, 255, 0.05),
                0 8px 32px rgba(0, 0, 0, 0.5),
                0 0 80px rgba(72, 49, 157, 0.15),
                inset 0 0 60px rgba(0, 0, 0, 0.1);
            animation: gameEntrance 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
            transform: scale(0.95) translateY(10px);
        }

        @keyframes gameEntrance {
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        #ruffle-player {
            width: 100%;
            height: 100%;
            background: #1a2e1a;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ==========================================================
           LOADER — Tela de carregamento animada
           ========================================================== */
        #loader-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #0d1117 0%, #161b22 50%, #0d1117 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: opacity 0.6s ease, visibility 0.6s ease;
        }

        #loader-overlay.fade-out {
            opacity: 0;
            visibility: hidden;
        }

        .loader-icon {
            width: 64px;
            height: 64px;
            margin-bottom: 24px;
            animation: loaderPulse 2s ease-in-out infinite;
        }

        @keyframes loaderPulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.08); opacity: 1; }
        }

        .loader-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(255, 255, 255, 0.08);
            border-top: 3px solid #00b4d8;
            border-right: 3px solid #7209b7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loader-title {
            font-size: 20px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 6px;
            letter-spacing: 1px;
        }

        .loader-title span {
            background: linear-gradient(90deg, #00b4d8, #7209b7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .loader-status {
            font-size: 13px;
            color: #6c7086;
            transition: color 0.3s;
        }

        .loader-bar-container {
            width: 200px;
            height: 3px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 2px;
            margin-top: 16px;
            overflow: hidden;
        }

        .loader-bar {
            width: 30%;
            height: 100%;
            background: linear-gradient(90deg, #00b4d8, #7209b7);
            border-radius: 2px;
            animation: loaderBar 1.5s ease-in-out infinite;
        }

        @keyframes loaderBar {
            0% { transform: translateX(-100%); width: 30%; }
            50% { width: 60%; }
            100% { transform: translateX(350%); width: 30%; }
        }

        /* ==========================================================
           FALLBACK — Erro do Ruffle
           ========================================================== */
        #ruffle-fallback {
            display: none;
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a0a0a 0%, #2d1117 100%);
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 55;
            padding: 40px 24px;
            text-align: center;
        }

        #ruffle-fallback .fallback-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        #ruffle-fallback h2 {
            color: #ff6b6b;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        #ruffle-fallback p {
            color: #a0a0a0;
            font-size: 13px;
            margin-bottom: 6px;
            max-width: 400px;
            line-height: 1.5;
        }

        #ruffle-fallback a {
            color: #00b4d8;
            text-decoration: none;
        }

        #ruffle-fallback a:hover {
            text-decoration: underline;
        }

        /* ==========================================================
           CONTROLES FLUTUANTES — Botões de ação
           ========================================================== */
        #controls-floating {
            position: fixed;
            bottom: 16px;
            right: 16px;
            z-index: 200;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        .ctrl-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(15, 15, 30, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            color: #c0c0d0;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.25s ease;
            white-space: nowrap;
            user-select: none;
            -webkit-user-select: none;
        }

        .ctrl-btn:hover {
            background: rgba(25, 25, 50, 0.95);
            border-color: rgba(0, 180, 216, 0.3);
            color: #ffffff;
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0, 180, 216, 0.15);
        }

        .ctrl-btn:active {
            transform: translateY(0);
        }

        .ctrl-btn svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .ctrl-btn.active {
            border-color: rgba(0, 180, 216, 0.5);
            color: #00b4d8;
            background: rgba(0, 180, 216, 0.1);
        }

        /* Botão toggle do header */
        #toggle-header-btn {
            position: fixed;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 150;
            padding: 4px 20px;
            background: rgba(15, 15, 30, 0.7);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 0 0 8px 8px;
            color: #6c7086;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.25s ease;
            display: none;
        }

        #toggle-header-btn:hover {
            color: #a0a0b0;
            background: rgba(25, 25, 50, 0.85);
        }

        /* ==========================================================
           NAV BAR — Links rápidos (estilo minimalista)
           ========================================================== */
        #nav-bar {
            position: fixed;
            bottom: 16px;
            left: 16px;
            z-index: 200;
            display: flex;
            gap: 6px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: rgba(15, 15, 30, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            color: #8888a0;
            font-size: 12px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.25s ease;
            white-space: nowrap;
        }

        .nav-link:hover {
            border-color: rgba(255, 255, 255, 0.12);
            color: #c0c0d0;
            transform: translateY(-1px);
        }

        .nav-link img {
            width: 14px;
            height: 14px;
            opacity: 0.7;
        }

        /* ==========================================================
           STATUS BAR — Barra inferior de status
           ========================================================== */
        #status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 90;
            text-align: center;
            padding: 3px 8px;
            font-size: 10px;
            color: #4a4a5a;
            background: rgba(10, 10, 20, 0.6);
            backdrop-filter: blur(4px);
            transition: opacity 0.5s ease;
        }

        /* ==========================================================
           OVERLAY MOBILE — Girar dispositivo
           ========================================================== */
        #rotate-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 9999;
            background: rgba(5, 5, 15, 0.97);
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 32px;
        }

        .rotate-icon {
            width: 80px;
            height: 80px;
            margin-bottom: 24px;
            animation: rotatePhone 2s ease-in-out infinite;
        }

        @keyframes rotatePhone {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(90deg); }
        }

        .rotate-title {
            font-size: 18px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .rotate-subtitle {
            font-size: 14px;
            color: #6c7086;
            max-width: 280px;
            line-height: 1.5;
        }

        .rotate-dismiss {
            margin-top: 24px;
            padding: 10px 24px;
            background: rgba(0, 180, 216, 0.15);
            border: 1px solid rgba(0, 180, 216, 0.3);
            border-radius: 8px;
            color: #00b4d8;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rotate-dismiss:hover {
            background: rgba(0, 180, 216, 0.25);
        }

        /* ==========================================================
           RESPONSIVIDADE
           ========================================================== */

        /* Tablets e telas médias */
        @media (max-width: 1024px) {
            #game-container {
                max-width: 100%;
                border-radius: 0;
                box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
            }

            #game-wrapper {
                padding: 44px 0 0 0;
            }
        }

        /* Mobile landscape */
        @media (max-width: 900px) and (orientation: landscape) {
            #header {
                padding: 4px 12px;
            }

            #game-wrapper {
                padding: 36px 0 0 0;
            }

            #game-container {
                max-height: calc(100vh - 40px);
                border-radius: 0;
            }

            #nav-bar {
                display: none;
            }

            #controls-floating {
                bottom: 8px;
                right: 8px;
            }

            .ctrl-btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            #status-bar {
                display: none;
            }
        }

        /* Mobile portrait */
        @media (max-width: 768px) and (orientation: portrait) {
            #header {
                padding: 6px 12px;
            }

            #header-title {
                font-size: 12px;
            }

            #session-info {
                font-size: 11px;
            }

            #game-wrapper {
                padding: 42px 0 0 0;
            }

            #game-container {
                border-radius: 0;
                aspect-ratio: auto;
                width: 100%;
                height: calc(100vh - 42px);
            }

            #nav-bar {
                display: none;
            }

            .ctrl-btn span.btn-label {
                display: none;
            }

            .ctrl-btn {
                padding: 10px;
                border-radius: 50%;
            }

            #controls-floating {
                bottom: 12px;
                right: 12px;
                gap: 6px;
            }
        }

        /* Telas muito pequenas */
        @media (max-width: 480px) {
            #header-left {
                gap: 6px;
            }

            #header-logo {
                width: 22px;
                height: 22px;
            }

            #session-info {
                font-size: 10px;
            }
        }

        /* ==========================================================
           UTILITÁRIOS
           ========================================================== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* Esconder scrollbar em todos os navegadores */
        ::-webkit-scrollbar { display: none; }
        * { scrollbar-width: none; }

        /* Desabilitar highlight em mobile */
        * {
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body>

    <!-- ============================================================
         HEADER — Sessão do usuário
         ============================================================ -->
    <header id="header">
        <div id="header-left">
            <img id="header-logo" src="img/icon.png" alt="SW" onerror="this.style.display='none'"/>
            <span id="header-title"><span>Social Wars</span></span>
        </div>
        <div id="session-info">
            <b>{{save_info.name}}</b> &middot; Lv {{save_info.level}}
            <a href="/" title="Sair">Logout</a>
        </div>
    </header>

    <!-- ============================================================
         GAME WRAPPER — Contém o jogo centralizado
         ============================================================ -->
    <main id="game-wrapper">
        <div id="game-container">

            <!-- Player do Ruffle -->
            <div id="ruffle-player"></div>

            <!-- Loader animado -->
            <div id="loader-overlay">
                <div class="loader-spinner"></div>
                <div class="loader-title"><span>Social Wars</span></div>
                <div class="loader-status" id="loader-status">Inicializando...</div>
                <div class="loader-bar-container">
                    <div class="loader-bar"></div>
                </div>
            </div>

            <!-- Fallback de erro -->
            <div id="ruffle-fallback">
                <div class="fallback-icon">&#9888;</div>
                <h2>Falha ao carregar o Ruffle</h2>
                <p>O emulador Flash (Ruffle) n&atilde;o p&ocirc;de ser iniciado. Poss&iacute;veis causas:</p>
                <p>Seu navegador n&atilde;o suporta WebAssembly, os arquivos do Ruffle falharam ao carregar, ou o SWF usa recursos ainda n&atilde;o suportados.</p>
                <br/>
                <p>Pressione F12 para verificar o Console.</p>
                <p>Visite <a href="https://ruffle.rs/" target="_blank" rel="noopener">ruffle.rs</a> para mais informa&ccedil;&otilde;es.</p>
            </div>

        </div>
    </main>

    <!-- ============================================================
         CONTROLES FLUTUANTES
         ============================================================ -->
    <div id="controls-floating">
        <!-- Botão Tela Cheia -->
        <button class="ctrl-btn" id="btn-fullscreen" onclick="goFullscreen()" title="Tela Cheia">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
            </svg>
            <span class="btn-label">Tela Cheia</span>
        </button>

        <!-- Botão Modo Toque (mobile) -->
        <button class="ctrl-btn" id="btn-touch" onclick="toggleTouchMode()" title="Modo Toque" style="display:none;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 11V6a2 2 0 0 0-2-2a2 2 0 0 0-2 2v0"/>
                <path d="M14 10V4a2 2 0 0 0-2-2a2 2 0 0 0-2 2v2"/>
                <path d="M10 10.5V6a2 2 0 0 0-2-2a2 2 0 0 0-2 2v8"/>
                <path d="M18 8a2 2 0 0 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/>
            </svg>
            <span class="btn-label">Modo Toque</span>
        </button>

        <!-- Botão Expandir -->
        <button class="ctrl-btn" id="btn-expand" onclick="toggleExpand()" title="Expandir">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="15 3 21 3 21 9"/>
                <polyline points="9 21 3 21 3 15"/>
                <line x1="21" y1="3" x2="14" y2="10"/>
                <line x1="3" y1="21" x2="10" y2="14"/>
            </svg>
            <span class="btn-label">Expandir</span>
        </button>
    </div>

    <!-- ============================================================
         NAV BAR — Links rápidos
         ============================================================ -->
    <nav id="nav-bar">
        <a class="nav-link" href="https://discord.gg/zW5gSbQJBw" target="_blank" rel="noopener" title="Discord">
            <img src="img/discord.png" alt="" onerror="this.style.display='none'"/>
            Discord
        </a>
        <a class="nav-link" href="https://github.com/AcidCaos/socialwarriors#readme" target="_blank" rel="noopener" title="GitHub">
            <img src="img/github.png" alt="" onerror="this.style.display='none'"/>
            GitHub
        </a>
    </nav>

    <!-- ============================================================
         STATUS BAR
         ============================================================ -->
    <div id="status-bar" aria-live="polite">Inicializando Ruffle...</div>

    <!-- ============================================================
         OVERLAY — Girar dispositivo (mobile portrait)
         ============================================================ -->
    <div id="rotate-overlay">
        <!-- Ícone SVG de celular girando -->
        <svg class="rotate-icon" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="25" y="10" width="50" height="80" rx="8" stroke="#00b4d8" stroke-width="3" fill="none"/>
            <circle cx="50" cy="80" r="3" fill="#00b4d8"/>
            <path d="M82 50 C82 30, 70 18, 50 18" stroke="#7209b7" stroke-width="2.5" fill="none" stroke-linecap="round"/>
            <polygon points="82,42 82,50 74,50" fill="#7209b7"/>
        </svg>
        <div class="rotate-title">Gire o dispositivo</div>
        <div class="rotate-subtitle">Para uma melhor experi&ecirc;ncia, use o modo paisagem (horizontal).</div>
        <button class="rotate-dismiss" onclick="dismissRotateOverlay()">Continuar mesmo assim</button>
    </div>

    <!-- ============================================================
         JAVASCRIPT — Lógica do jogo e UX
         ============================================================ -->
    <script>
        /* ===========================================================
           CONFIGURAÇÃO (injetada pelo Jinja2 / Flask)
           =========================================================== */
        const SERVER_ORIGIN = window.location.protocol + "//" + window.location.host;
        const SWF_LOADER    = "/static/socialwars/flash/SWLoader.swf";
        const SWF_GAME      = "/static/socialwars/flash/{{GAMEVERSION}}";
        const STATIC_URL    = SERVER_ORIGIN + "/static/socialwars/";
        const DYNAMIC_URL   = SERVER_ORIGIN + "/dynamic/menvswomen/srvsexwars/";

        const FLASH_VARS = {
            "spdebug":             "notnull",
            "brk":                 "0",
            "staticUrl":           STATIC_URL,
            "dynamicUrl":          DYNAMIC_URL,
            "skiphash12341":       "notnull",
            "fb_sig_user":         "{{save_info.userid}}",
            "user_key":            "123456789",
            "language":            "en",
            "accessToken":         "AAABbZAm0wdMUBALsOrR0Ho68CLjaOT8SV3vftKg9mbo1zZColaW5FljRVaLxPGxXXnm1M98mTZCAttcQ4GHwvSyXfsyxYmvKMH8Hmn5iliSPnjvIsZA6",
            "sex":                 "m",
            "lastLoggedIn":        "1349266517",
            "dailyBonus":          "0",
            "friendsInfo":         '{{friendsInfo | tojson}}',
            "serverTime":          "{{serverTime}}",
            "forceSyncError":      "1",
            "forceAttackReload":   "0",
            "forceQuestReload":    "0"
        };

        const FULL_SWF_URL = SWF_LOADER + "?swftoload=" + encodeURIComponent(SWF_GAME);

        /* ===========================================================
           REFERÊNCIAS DOM
           =========================================================== */
        const statusBar     = document.getElementById("status-bar");
        const loaderOverlay = document.getElementById("loader-overlay");
        const loaderStatus  = document.getElementById("loader-status");
        const container     = document.getElementById("ruffle-player");
        const fallback      = document.getElementById("ruffle-fallback");
        const gameContainer = document.getElementById("game-container");
        const header        = document.getElementById("header");
        const rotateOverlay = document.getElementById("rotate-overlay");

        /* ===========================================================
           DETECÇÃO MOBILE
           =========================================================== */
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
                         || (navigator.maxTouchPoints && navigator.maxTouchPoints > 2);

        /* Mostrar botão de toque em mobile */
        if (isMobile) {
            document.getElementById("btn-touch").style.display = "flex";
        }

        /* ===========================================================
           OVERLAY DE ROTAÇÃO (mobile portrait)
           =========================================================== */
        let rotateOverlayDismissed = false;

        function checkOrientation() {
            if (!isMobile || rotateOverlayDismissed) {
                rotateOverlay.style.display = "none";
                return;
            }

            const isPortrait = window.innerHeight > window.innerWidth;
            rotateOverlay.style.display = isPortrait ? "flex" : "none";
        }

        function dismissRotateOverlay() {
            rotateOverlayDismissed = true;
            rotateOverlay.style.display = "none";
        }

        window.addEventListener("resize", checkOrientation);
        window.addEventListener("orientationchange", function() {
            setTimeout(checkOrientation, 100);
        });

        /* Verificar na carga inicial */
        checkOrientation();

        /* ===========================================================
           RUFFLE BOOTSTRAP
           =========================================================== */
        function updateStatus(msg) {
            statusBar.textContent = msg;
            loaderStatus.textContent = msg;
        }

        function showFallback(msg) {
            container.style.display = "none";
            loaderOverlay.style.display = "none";
            fallback.style.display = "flex";
            statusBar.textContent = msg;
            console.error("[SW-Ruffle]", msg);
        }

        async function startRuffle() {
            try {
                updateStatus("Carregando engine Ruffle...");

                const ruffle = window.RufflePlayer.newest();
                const player = ruffle.createPlayer();
                player.style.width  = "100%";
                player.style.height = "100%";
                container.appendChild(player);

                updateStatus("Carregando SWF (pode levar um momento)...");

                await player.load({
                    url:                      FULL_SWF_URL,
                    parameters:               FLASH_VARS,
                    autoplay:                 "on",
                    unmuteOverlay:            "hidden",
                    backgroundColor:          "#669C2C",
                    letterbox:                "on",
                    warnOnUnsupportedContent: true,
                    logLevel:                 "warn",
                    maxExecutionDuration:     { secs: 60, nanos: 0 },
                    playerVersion:            32,
                    quality:                  "high",
                    allowNetworking:          "all",
                    openUrlMode:              "allow",
                    allowScriptAccess:        true
                });

                /* Esconder loader com animação */
                loaderOverlay.classList.add("fade-out");
                setTimeout(function() {
                    loaderOverlay.style.display = "none";
                }, 600);

                updateStatus("Jogo carregado! (Ruffle Flash Emulator)");

                /* Esconder status bar após 5 segundos */
                setTimeout(function() {
                    statusBar.style.opacity = "0";
                }, 5000);

                console.log("[SW-Ruffle] SWF loaded successfully.");

            } catch (e) {
                showFallback("Erro no Ruffle: " + e.message);
            }
        }

        /* ===========================================================
           CONTROLES — Expandir, Tela Cheia, Modo Toque
           =========================================================== */
        let expanded = false;
        function toggleExpand() {
            expanded = !expanded;
            const btn = document.getElementById("btn-expand");

            if (expanded) {
                gameContainer.style.maxWidth = "100%";
                gameContainer.style.borderRadius = "0";
                btn.classList.add("active");
                btn.querySelector(".btn-label").textContent = "Contrair";
                btn.title = "Contrair";
            } else {
                gameContainer.style.maxWidth = "960px";
                gameContainer.style.borderRadius = "12px";
                btn.classList.remove("active");
                btn.querySelector(".btn-label").textContent = "Expandir";
                btn.title = "Expandir";
            }
        }

        function goFullscreen() {
            const el = document.documentElement;
            const rq = el.requestFullscreen
                    || el.webkitRequestFullscreen
                    || el.msRequestFullscreen;

            if (rq) {
                rq.call(el).then(function() {
                    /* Esconder header em fullscreen */
                    header.classList.add("hidden");
                }).catch(function() {});
            }
        }

        /* Restaurar header ao sair do fullscreen */
        document.addEventListener("fullscreenchange", function() {
            if (!document.fullscreenElement) {
                header.classList.remove("hidden");
            }
        });
        document.addEventListener("webkitfullscreenchange", function() {
            if (!document.webkitFullscreenElement) {
                header.classList.remove("hidden");
            }
        });

        /* Modo Toque */
        let touchMode = false;
        function toggleTouchMode() {
            touchMode = !touchMode;
            const btn = document.getElementById("btn-touch");

            if (touchMode) {
                btn.classList.add("active");
                btn.querySelector(".btn-label").textContent = "Toque: ON";
                document.body.style.touchAction = "none";

                /* Interceptar eventos de toque e converter para cliques */
                container.addEventListener("touchstart", touchHandler, { passive: false });
                container.addEventListener("touchmove", touchHandler, { passive: false });
                container.addEventListener("touchend", touchHandler, { passive: false });
            } else {
                btn.classList.remove("active");
                btn.querySelector(".btn-label").textContent = "Modo Toque";
                document.body.style.touchAction = "manipulation";

                container.removeEventListener("touchstart", touchHandler);
                container.removeEventListener("touchmove", touchHandler);
                container.removeEventListener("touchend", touchHandler);
            }
        }

        function touchHandler(e) {
            e.preventDefault();
            const touch = e.changedTouches[0];
            const types = {
                touchstart: "mousedown",
                touchmove:  "mousemove",
                touchend:   "mouseup"
            };

            const mouseEvent = new MouseEvent(types[e.type], {
                bubbles: true,
                cancelable: true,
                view: window,
                clientX: touch.clientX,
                clientY: touch.clientY,
                screenX: touch.screenX,
                screenY: touch.screenY
            });

            touch.target.dispatchEvent(mouseEvent);
        }

        /* ===========================================================
           PREVENÇÃO DE ZOOM E SCROLL (mobile)
           =========================================================== */
        document.addEventListener("gesturestart", function(e) { e.preventDefault(); });
        document.addEventListener("gesturechange", function(e) { e.preventDefault(); });
        document.addEventListener("gestureend", function(e) { e.preventDefault(); });

        /* Prevenir double-tap zoom */
        let lastTouchEnd = 0;
        document.addEventListener("touchend", function(e) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        /* Prevenir scroll */
        document.body.addEventListener("touchmove", function(e) {
            if (e.target.closest("#game-container")) {
                e.preventDefault();
            }
        }, { passive: false });

        /* ===========================================================
           COOKIE HELPERS (preservados do original)
           =========================================================== */
        function setCookie(n, v, d) {
            var e = new Date();
            e.setDate(e.getDate() + d);
            document.cookie = n + "=" + encodeURIComponent(v) + ";expires=" + e.toUTCString() + ";path=/";
        }

        function getCookie(n) {
            var c = document.cookie.split(";");
            for (var i = 0; i < c.length; i++) {
                var p = c[i].split("=");
                if (p[0].trim() === n) return decodeURIComponent(p[1]);
            }
            return null;
        }

        /* ===========================================================
           KEYBOARD SHORTCUT — F11 alternativa
           =========================================================== */
        document.addEventListener("keydown", function(e) {
            if (e.key === "F11") {
                e.preventDefault();
                goFullscreen();
            }
        });
    </script>

    <!-- ============================================================
         RUFFLE — Carregado APÓS o DOM e scripts de inicialização
         ============================================================ -->
    <script
        src="/ruffle/ruffle.js"
        onload="startRuffle()"
        onerror="showFallback('Falha ao carregar /ruffle/ruffle.js — verifique se os arquivos do Ruffle estão sendo servidos corretamente.')">
    </script>

</body>
</html>
